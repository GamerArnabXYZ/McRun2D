<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>MC Run</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        @font-face {
            font-family: Minecraft;
            src: url('fonts/Minecraft.ttf');
        }

        * {
            margin: 0;
            padding: 0;
            font-family: Minecraft;
            user-select: none;
            overflow: hidden;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(#87CEEB, #d0f4ff);
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #scoreContainer,
        #emeraldContainer {
            position: absolute;
            top: 2vh;
            font-size: 4vw;
            padding: 1vh 2vw;
            border-radius: 1vw;
            background: rgba(0, 0, 0, 0.5);
        }

        #scoreContainer {
            left: 2vw;
            color: white;
        }

        #emeraldContainer {
            right: 2vw;
            color: yellow;
        }

        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
        }

        #gameOver h1 {
            font-size: 10vw;
        }

        #gameOver p {
            font-size: 4.5vw;
            margin-top: 2vh;
        }

        .btns {
            margin-top: 5vh;
            display: flex;
        }

        .mc-button {
            width: 50vw;
            max-width: 160px;
            height: 19vw;
            max-height: 40px;
            background: url('images/button.png') no-repeat center center;
            background-size: 100% 100%;
            color: white;
            font-size: 4vw;
            border: none;
            margin: 0 2vw;
            font-family: Minecraft;
            text-shadow: 1px 1px 0 #000;
            cursor: touch;
            transition: transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mc-button:active {
            transform: scale(0.85);
        }

        #jumpBtn {
            position: absolute;
            bottom: 5vh;
            right: 5vw;
            width: 20vw;
            max-width: 80px;
            height: 20vw;
            max-height: 80px;
            background: url('images/jump.png') no-repeat center center;
            background-size: cover;
            border: none;
        }
    </style>
</head>

<body>
    <canvas id="gameCanvas"></canvas>
    <div id="scoreContainer">Score: 0</div>
    <div id="emeraldContainer">Emeralds: 0</div>
    <div id="gameOver">
        <h1>YOU DIED!</h1>
        <p>Steve was blown up by TNT</p>
        <p id="finalScore">Score: 0</p>
        <div class="btns">
            <button class="mc-button" onclick="location.reload()">Respawn</button>
            <button class="mc-button" onclick="location.href='index.html'">Title Screen</button>
        </div>
    </div><button id="jumpBtn"></button>

    <!-- Load skins definitions first -->
    <script src="skins.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = innerWidth;
        canvas.height = innerHeight;

        const block = canvas.height / 10;
        const pW = block * 2.2;
        const pH = block * 3;
        const gH = block;
        const tW = block;
        const tH = block;
        const speed = 5;
        const marginX = pW * 0.25;
        const marginY = pH * 0.15;

        let score = 0;
        let emeralds = parseInt(localStorage.getItem('emeralds')) || 0;
        let playerY = canvas.height - pH - gH;
        let vy = 0;
        let gravity = 1.2;
        let jumping = false;
        let tntX = canvas.width + 200;
        let grassX = 0;
        let over = false;

        document.getElementById('emeraldContainer').innerText = 'Emeralds: ' + emeralds;

        // Choose equipped skin from localStorage
        const equipped = localStorage.getItem('equippedSkin') || 'steve';
        const skinObj = skins.find(s => s.id === equipped) || skins[0];
        const playerImg = new Image();
        playerImg.src = skinObj.image;

        const tntImg = new Image();
        tntImg.src = 'images/tnt.png';
        const grassImg = new Image();
        grassImg.src = 'images/grass.png';

        function drawPlayer() {
            ctx.drawImage(playerImg, 50, playerY, pW, pH);
        }

        function drawTNT() {
            ctx.drawImage(tntImg, tntX, canvas.height - gH - tH, tW, tH);
        }

        function drawGrass() {
            ctx.drawImage(grassImg, grassX, canvas.height - gH, canvas.width, gH);
            ctx.drawImage(grassImg, grassX + canvas.width, canvas.height - gH, canvas.width, gH);
        }

        function update() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGrass();
            drawPlayer();
            drawTNT();

            if (!over) {
                // Jump physics
                if (jumping) {
                    playerY += vy;
                    vy += gravity;
                    if (playerY >= canvas.height - pH - gH) {
                        playerY = canvas.height - pH - gH;
                        jumping = false;
                    }
                }
                // Scroll
                tntX -= speed;
                grassX -= speed;
                if (grassX <= -canvas.width) grassX = 0;
                // Recycle TNT & score
                if (tntX + tW < 0) {
                    tntX = canvas.width + Math.random() * 500;
                    score++;
                    if (score % 10 === 0) emeralds++;
                    localStorage.setItem('emeralds', emeralds);
                    document.getElementById('scoreContainer').innerText = 'Score: ' + score;
                    document.getElementById('emeraldContainer').innerText = 'Emeralds: ' + emeralds;
                }
                // Collision using reduced hit-box
                const px1 = 50 + marginX;
                const px2 = 50 + pW - marginX;
                const py1 = playerY + marginY;
                const py2 = playerY + pH;
                const tx1 = tntX;
                const tx2 = tntX + tW;
                const ty = canvas.height - gH - tH;
                if (px2 > tx1 && px1 < tx2 && py2 > ty) {
                    over = true;
                    document.getElementById('finalScore').innerText = 'Score: ' + score;
                    document.getElementById('gameOver').style.display = 'flex';
                }
            }
            requestAnimationFrame(update);
        }

        document.getElementById('jumpBtn').addEventListener('click', () => {
            if (!jumping && !over) {
                jumping = true;
                vy = -block * 0.4;
            }
        });

        window.onload = update;
    </script>
</body>

</html>
